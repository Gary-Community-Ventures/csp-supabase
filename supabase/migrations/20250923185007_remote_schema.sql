revoke delete on table "public"."alembic_version" from "anon";

revoke insert on table "public"."alembic_version" from "anon";

revoke references on table "public"."alembic_version" from "anon";

revoke select on table "public"."alembic_version" from "anon";

revoke trigger on table "public"."alembic_version" from "anon";

revoke truncate on table "public"."alembic_version" from "anon";

revoke update on table "public"."alembic_version" from "anon";

revoke delete on table "public"."alembic_version" from "authenticated";

revoke insert on table "public"."alembic_version" from "authenticated";

revoke references on table "public"."alembic_version" from "authenticated";

revoke select on table "public"."alembic_version" from "authenticated";

revoke trigger on table "public"."alembic_version" from "authenticated";

revoke truncate on table "public"."alembic_version" from "authenticated";

revoke update on table "public"."alembic_version" from "authenticated";

revoke delete on table "public"."alembic_version" from "service_role";

revoke insert on table "public"."alembic_version" from "service_role";

revoke references on table "public"."alembic_version" from "service_role";

revoke select on table "public"."alembic_version" from "service_role";

revoke trigger on table "public"."alembic_version" from "service_role";

revoke truncate on table "public"."alembic_version" from "service_role";

revoke update on table "public"."alembic_version" from "service_role";

revoke delete on table "public"."allocated_care_day" from "anon";

revoke insert on table "public"."allocated_care_day" from "anon";

revoke references on table "public"."allocated_care_day" from "anon";

revoke select on table "public"."allocated_care_day" from "anon";

revoke trigger on table "public"."allocated_care_day" from "anon";

revoke truncate on table "public"."allocated_care_day" from "anon";

revoke update on table "public"."allocated_care_day" from "anon";

revoke delete on table "public"."allocated_care_day" from "authenticated";

revoke insert on table "public"."allocated_care_day" from "authenticated";

revoke references on table "public"."allocated_care_day" from "authenticated";

revoke select on table "public"."allocated_care_day" from "authenticated";

revoke trigger on table "public"."allocated_care_day" from "authenticated";

revoke truncate on table "public"."allocated_care_day" from "authenticated";

revoke update on table "public"."allocated_care_day" from "authenticated";

revoke delete on table "public"."allocated_care_day" from "service_role";

revoke insert on table "public"."allocated_care_day" from "service_role";

revoke references on table "public"."allocated_care_day" from "service_role";

revoke select on table "public"."allocated_care_day" from "service_role";

revoke trigger on table "public"."allocated_care_day" from "service_role";

revoke truncate on table "public"."allocated_care_day" from "service_role";

revoke update on table "public"."allocated_care_day" from "service_role";

revoke delete on table "public"."child" from "anon";

revoke insert on table "public"."child" from "anon";

revoke references on table "public"."child" from "anon";

revoke select on table "public"."child" from "anon";

revoke trigger on table "public"."child" from "anon";

revoke truncate on table "public"."child" from "anon";

revoke update on table "public"."child" from "anon";

revoke delete on table "public"."child" from "authenticated";

revoke insert on table "public"."child" from "authenticated";

revoke references on table "public"."child" from "authenticated";

revoke select on table "public"."child" from "authenticated";

revoke trigger on table "public"."child" from "authenticated";

revoke truncate on table "public"."child" from "authenticated";

revoke update on table "public"."child" from "authenticated";

revoke delete on table "public"."child" from "service_role";

revoke insert on table "public"."child" from "service_role";

revoke references on table "public"."child" from "service_role";

revoke select on table "public"."child" from "service_role";

revoke trigger on table "public"."child" from "service_role";

revoke truncate on table "public"."child" from "service_role";

revoke update on table "public"."child" from "service_role";

revoke delete on table "public"."family" from "anon";

revoke insert on table "public"."family" from "anon";

revoke references on table "public"."family" from "anon";

revoke select on table "public"."family" from "anon";

revoke trigger on table "public"."family" from "anon";

revoke truncate on table "public"."family" from "anon";

revoke update on table "public"."family" from "anon";

revoke delete on table "public"."family" from "authenticated";

revoke insert on table "public"."family" from "authenticated";

revoke references on table "public"."family" from "authenticated";

revoke select on table "public"."family" from "authenticated";

revoke trigger on table "public"."family" from "authenticated";

revoke truncate on table "public"."family" from "authenticated";

revoke update on table "public"."family" from "authenticated";

revoke delete on table "public"."family" from "service_role";

revoke insert on table "public"."family" from "service_role";

revoke references on table "public"."family" from "service_role";

revoke select on table "public"."family" from "service_role";

revoke trigger on table "public"."family" from "service_role";

revoke truncate on table "public"."family" from "service_role";

revoke update on table "public"."family" from "service_role";

revoke delete on table "public"."family_application" from "anon";

revoke insert on table "public"."family_application" from "anon";

revoke references on table "public"."family_application" from "anon";

revoke select on table "public"."family_application" from "anon";

revoke trigger on table "public"."family_application" from "anon";

revoke truncate on table "public"."family_application" from "anon";

revoke update on table "public"."family_application" from "anon";

revoke delete on table "public"."family_application" from "authenticated";

revoke insert on table "public"."family_application" from "authenticated";

revoke references on table "public"."family_application" from "authenticated";

revoke select on table "public"."family_application" from "authenticated";

revoke trigger on table "public"."family_application" from "authenticated";

revoke truncate on table "public"."family_application" from "authenticated";

revoke update on table "public"."family_application" from "authenticated";

revoke delete on table "public"."family_application" from "service_role";

revoke insert on table "public"."family_application" from "service_role";

revoke references on table "public"."family_application" from "service_role";

revoke select on table "public"."family_application" from "service_role";

revoke trigger on table "public"."family_application" from "service_role";

revoke truncate on table "public"."family_application" from "service_role";

revoke update on table "public"."family_application" from "service_role";

revoke delete on table "public"."family_approval" from "anon";

revoke insert on table "public"."family_approval" from "anon";

revoke references on table "public"."family_approval" from "anon";

revoke select on table "public"."family_approval" from "anon";

revoke trigger on table "public"."family_approval" from "anon";

revoke truncate on table "public"."family_approval" from "anon";

revoke update on table "public"."family_approval" from "anon";

revoke delete on table "public"."family_approval" from "authenticated";

revoke insert on table "public"."family_approval" from "authenticated";

revoke references on table "public"."family_approval" from "authenticated";

revoke select on table "public"."family_approval" from "authenticated";

revoke trigger on table "public"."family_approval" from "authenticated";

revoke truncate on table "public"."family_approval" from "authenticated";

revoke update on table "public"."family_approval" from "authenticated";

revoke delete on table "public"."family_approval" from "service_role";

revoke insert on table "public"."family_approval" from "service_role";

revoke references on table "public"."family_approval" from "service_role";

revoke select on table "public"."family_approval" from "service_role";

revoke trigger on table "public"."family_approval" from "service_role";

revoke truncate on table "public"."family_approval" from "service_role";

revoke update on table "public"."family_approval" from "service_role";

revoke delete on table "public"."family_invitation" from "anon";

revoke insert on table "public"."family_invitation" from "anon";

revoke references on table "public"."family_invitation" from "anon";

revoke select on table "public"."family_invitation" from "anon";

revoke trigger on table "public"."family_invitation" from "anon";

revoke truncate on table "public"."family_invitation" from "anon";

revoke update on table "public"."family_invitation" from "anon";

revoke delete on table "public"."family_invitation" from "authenticated";

revoke insert on table "public"."family_invitation" from "authenticated";

revoke references on table "public"."family_invitation" from "authenticated";

revoke select on table "public"."family_invitation" from "authenticated";

revoke trigger on table "public"."family_invitation" from "authenticated";

revoke truncate on table "public"."family_invitation" from "authenticated";

revoke update on table "public"."family_invitation" from "authenticated";

revoke delete on table "public"."family_invitation" from "service_role";

revoke insert on table "public"."family_invitation" from "service_role";

revoke references on table "public"."family_invitation" from "service_role";

revoke select on table "public"."family_invitation" from "service_role";

revoke trigger on table "public"."family_invitation" from "service_role";

revoke truncate on table "public"."family_invitation" from "service_role";

revoke update on table "public"."family_invitation" from "service_role";

revoke delete on table "public"."fpl" from "anon";

revoke insert on table "public"."fpl" from "anon";

revoke references on table "public"."fpl" from "anon";

revoke select on table "public"."fpl" from "anon";

revoke trigger on table "public"."fpl" from "anon";

revoke truncate on table "public"."fpl" from "anon";

revoke update on table "public"."fpl" from "anon";

revoke delete on table "public"."fpl" from "authenticated";

revoke insert on table "public"."fpl" from "authenticated";

revoke references on table "public"."fpl" from "authenticated";

revoke select on table "public"."fpl" from "authenticated";

revoke trigger on table "public"."fpl" from "authenticated";

revoke truncate on table "public"."fpl" from "authenticated";

revoke update on table "public"."fpl" from "authenticated";

revoke delete on table "public"."fpl" from "service_role";

revoke insert on table "public"."fpl" from "service_role";

revoke references on table "public"."fpl" from "service_role";

revoke select on table "public"."fpl" from "service_role";

revoke trigger on table "public"."fpl" from "service_role";

revoke truncate on table "public"."fpl" from "service_role";

revoke update on table "public"."fpl" from "service_role";

revoke delete on table "public"."guardian" from "anon";

revoke insert on table "public"."guardian" from "anon";

revoke references on table "public"."guardian" from "anon";

revoke select on table "public"."guardian" from "anon";

revoke trigger on table "public"."guardian" from "anon";

revoke truncate on table "public"."guardian" from "anon";

revoke update on table "public"."guardian" from "anon";

revoke delete on table "public"."guardian" from "authenticated";

revoke insert on table "public"."guardian" from "authenticated";

revoke references on table "public"."guardian" from "authenticated";

revoke select on table "public"."guardian" from "authenticated";

revoke trigger on table "public"."guardian" from "authenticated";

revoke truncate on table "public"."guardian" from "authenticated";

revoke update on table "public"."guardian" from "authenticated";

revoke delete on table "public"."guardian" from "service_role";

revoke insert on table "public"."guardian" from "service_role";

revoke references on table "public"."guardian" from "service_role";

revoke select on table "public"."guardian" from "service_role";

revoke trigger on table "public"."guardian" from "service_role";

revoke truncate on table "public"."guardian" from "service_role";

revoke update on table "public"."guardian" from "service_role";

revoke delete on table "public"."monthly_allocation" from "anon";

revoke insert on table "public"."monthly_allocation" from "anon";

revoke references on table "public"."monthly_allocation" from "anon";

revoke select on table "public"."monthly_allocation" from "anon";

revoke trigger on table "public"."monthly_allocation" from "anon";

revoke truncate on table "public"."monthly_allocation" from "anon";

revoke update on table "public"."monthly_allocation" from "anon";

revoke delete on table "public"."monthly_allocation" from "authenticated";

revoke insert on table "public"."monthly_allocation" from "authenticated";

revoke references on table "public"."monthly_allocation" from "authenticated";

revoke select on table "public"."monthly_allocation" from "authenticated";

revoke trigger on table "public"."monthly_allocation" from "authenticated";

revoke truncate on table "public"."monthly_allocation" from "authenticated";

revoke update on table "public"."monthly_allocation" from "authenticated";

revoke delete on table "public"."monthly_allocation" from "service_role";

revoke insert on table "public"."monthly_allocation" from "service_role";

revoke references on table "public"."monthly_allocation" from "service_role";

revoke select on table "public"."monthly_allocation" from "service_role";

revoke trigger on table "public"."monthly_allocation" from "service_role";

revoke truncate on table "public"."monthly_allocation" from "service_role";

revoke update on table "public"."monthly_allocation" from "service_role";

revoke delete on table "public"."payment_rate" from "anon";

revoke insert on table "public"."payment_rate" from "anon";

revoke references on table "public"."payment_rate" from "anon";

revoke select on table "public"."payment_rate" from "anon";

revoke trigger on table "public"."payment_rate" from "anon";

revoke truncate on table "public"."payment_rate" from "anon";

revoke update on table "public"."payment_rate" from "anon";

revoke delete on table "public"."payment_rate" from "authenticated";

revoke insert on table "public"."payment_rate" from "authenticated";

revoke references on table "public"."payment_rate" from "authenticated";

revoke select on table "public"."payment_rate" from "authenticated";

revoke trigger on table "public"."payment_rate" from "authenticated";

revoke truncate on table "public"."payment_rate" from "authenticated";

revoke update on table "public"."payment_rate" from "authenticated";

revoke delete on table "public"."payment_rate" from "service_role";

revoke insert on table "public"."payment_rate" from "service_role";

revoke references on table "public"."payment_rate" from "service_role";

revoke select on table "public"."payment_rate" from "service_role";

revoke trigger on table "public"."payment_rate" from "service_role";

revoke truncate on table "public"."payment_rate" from "service_role";

revoke update on table "public"."payment_rate" from "service_role";

revoke delete on table "public"."payment_request" from "anon";

revoke insert on table "public"."payment_request" from "anon";

revoke references on table "public"."payment_request" from "anon";

revoke select on table "public"."payment_request" from "anon";

revoke trigger on table "public"."payment_request" from "anon";

revoke truncate on table "public"."payment_request" from "anon";

revoke update on table "public"."payment_request" from "anon";

revoke delete on table "public"."payment_request" from "authenticated";

revoke insert on table "public"."payment_request" from "authenticated";

revoke references on table "public"."payment_request" from "authenticated";

revoke select on table "public"."payment_request" from "authenticated";

revoke trigger on table "public"."payment_request" from "authenticated";

revoke truncate on table "public"."payment_request" from "authenticated";

revoke update on table "public"."payment_request" from "authenticated";

revoke delete on table "public"."payment_request" from "service_role";

revoke insert on table "public"."payment_request" from "service_role";

revoke references on table "public"."payment_request" from "service_role";

revoke select on table "public"."payment_request" from "service_role";

revoke trigger on table "public"."payment_request" from "service_role";

revoke truncate on table "public"."payment_request" from "service_role";

revoke update on table "public"."payment_request" from "service_role";

revoke delete on table "public"."provider" from "anon";

revoke insert on table "public"."provider" from "anon";

revoke references on table "public"."provider" from "anon";

revoke select on table "public"."provider" from "anon";

revoke trigger on table "public"."provider" from "anon";

revoke truncate on table "public"."provider" from "anon";

revoke update on table "public"."provider" from "anon";

revoke delete on table "public"."provider" from "authenticated";

revoke insert on table "public"."provider" from "authenticated";

revoke references on table "public"."provider" from "authenticated";

revoke select on table "public"."provider" from "authenticated";

revoke trigger on table "public"."provider" from "authenticated";

revoke truncate on table "public"."provider" from "authenticated";

revoke update on table "public"."provider" from "authenticated";

revoke delete on table "public"."provider" from "service_role";

revoke insert on table "public"."provider" from "service_role";

revoke references on table "public"."provider" from "service_role";

revoke select on table "public"."provider" from "service_role";

revoke trigger on table "public"."provider" from "service_role";

revoke truncate on table "public"."provider" from "service_role";

revoke update on table "public"."provider" from "service_role";

revoke delete on table "public"."provider_application" from "anon";

revoke insert on table "public"."provider_application" from "anon";

revoke references on table "public"."provider_application" from "anon";

revoke select on table "public"."provider_application" from "anon";

revoke trigger on table "public"."provider_application" from "anon";

revoke truncate on table "public"."provider_application" from "anon";

revoke update on table "public"."provider_application" from "anon";

revoke delete on table "public"."provider_application" from "authenticated";

revoke insert on table "public"."provider_application" from "authenticated";

revoke references on table "public"."provider_application" from "authenticated";

revoke select on table "public"."provider_application" from "authenticated";

revoke trigger on table "public"."provider_application" from "authenticated";

revoke truncate on table "public"."provider_application" from "authenticated";

revoke update on table "public"."provider_application" from "authenticated";

revoke delete on table "public"."provider_application" from "service_role";

revoke insert on table "public"."provider_application" from "service_role";

revoke references on table "public"."provider_application" from "service_role";

revoke select on table "public"."provider_application" from "service_role";

revoke trigger on table "public"."provider_application" from "service_role";

revoke truncate on table "public"."provider_application" from "service_role";

revoke update on table "public"."provider_application" from "service_role";

revoke delete on table "public"."provider_approval" from "anon";

revoke insert on table "public"."provider_approval" from "anon";

revoke references on table "public"."provider_approval" from "anon";

revoke select on table "public"."provider_approval" from "anon";

revoke trigger on table "public"."provider_approval" from "anon";

revoke truncate on table "public"."provider_approval" from "anon";

revoke update on table "public"."provider_approval" from "anon";

revoke delete on table "public"."provider_approval" from "authenticated";

revoke insert on table "public"."provider_approval" from "authenticated";

revoke references on table "public"."provider_approval" from "authenticated";

revoke select on table "public"."provider_approval" from "authenticated";

revoke trigger on table "public"."provider_approval" from "authenticated";

revoke truncate on table "public"."provider_approval" from "authenticated";

revoke update on table "public"."provider_approval" from "authenticated";

revoke delete on table "public"."provider_approval" from "service_role";

revoke insert on table "public"."provider_approval" from "service_role";

revoke references on table "public"."provider_approval" from "service_role";

revoke select on table "public"."provider_approval" from "service_role";

revoke trigger on table "public"."provider_approval" from "service_role";

revoke truncate on table "public"."provider_approval" from "service_role";

revoke update on table "public"."provider_approval" from "service_role";

revoke delete on table "public"."provider_child_mapping" from "anon";

revoke insert on table "public"."provider_child_mapping" from "anon";

revoke references on table "public"."provider_child_mapping" from "anon";

revoke select on table "public"."provider_child_mapping" from "anon";

revoke trigger on table "public"."provider_child_mapping" from "anon";

revoke truncate on table "public"."provider_child_mapping" from "anon";

revoke update on table "public"."provider_child_mapping" from "anon";

revoke delete on table "public"."provider_child_mapping" from "authenticated";

revoke insert on table "public"."provider_child_mapping" from "authenticated";

revoke references on table "public"."provider_child_mapping" from "authenticated";

revoke select on table "public"."provider_child_mapping" from "authenticated";

revoke trigger on table "public"."provider_child_mapping" from "authenticated";

revoke truncate on table "public"."provider_child_mapping" from "authenticated";

revoke update on table "public"."provider_child_mapping" from "authenticated";

revoke delete on table "public"."provider_child_mapping" from "service_role";

revoke insert on table "public"."provider_child_mapping" from "service_role";

revoke references on table "public"."provider_child_mapping" from "service_role";

revoke select on table "public"."provider_child_mapping" from "service_role";

revoke trigger on table "public"."provider_child_mapping" from "service_role";

revoke truncate on table "public"."provider_child_mapping" from "service_role";

revoke update on table "public"."provider_child_mapping" from "service_role";

revoke delete on table "public"."provider_invitation" from "anon";

revoke insert on table "public"."provider_invitation" from "anon";

revoke references on table "public"."provider_invitation" from "anon";

revoke select on table "public"."provider_invitation" from "anon";

revoke trigger on table "public"."provider_invitation" from "anon";

revoke truncate on table "public"."provider_invitation" from "anon";

revoke update on table "public"."provider_invitation" from "anon";

revoke delete on table "public"."provider_invitation" from "authenticated";

revoke insert on table "public"."provider_invitation" from "authenticated";

revoke references on table "public"."provider_invitation" from "authenticated";

revoke select on table "public"."provider_invitation" from "authenticated";

revoke trigger on table "public"."provider_invitation" from "authenticated";

revoke truncate on table "public"."provider_invitation" from "authenticated";

revoke update on table "public"."provider_invitation" from "authenticated";

revoke delete on table "public"."provider_invitation" from "service_role";

revoke insert on table "public"."provider_invitation" from "service_role";

revoke references on table "public"."provider_invitation" from "service_role";

revoke select on table "public"."provider_invitation" from "service_role";

revoke trigger on table "public"."provider_invitation" from "service_role";

revoke truncate on table "public"."provider_invitation" from "service_role";

revoke update on table "public"."provider_invitation" from "service_role";

revoke delete on table "public"."ruca" from "anon";

revoke insert on table "public"."ruca" from "anon";

revoke references on table "public"."ruca" from "anon";

revoke select on table "public"."ruca" from "anon";

revoke trigger on table "public"."ruca" from "anon";

revoke truncate on table "public"."ruca" from "anon";

revoke update on table "public"."ruca" from "anon";

revoke delete on table "public"."ruca" from "authenticated";

revoke insert on table "public"."ruca" from "authenticated";

revoke references on table "public"."ruca" from "authenticated";

revoke select on table "public"."ruca" from "authenticated";

revoke trigger on table "public"."ruca" from "authenticated";

revoke truncate on table "public"."ruca" from "authenticated";

revoke update on table "public"."ruca" from "authenticated";

revoke delete on table "public"."ruca" from "service_role";

revoke insert on table "public"."ruca" from "service_role";

revoke references on table "public"."ruca" from "service_role";

revoke select on table "public"."ruca" from "service_role";

revoke trigger on table "public"."ruca" from "service_role";

revoke truncate on table "public"."ruca" from "service_role";

revoke update on table "public"."ruca" from "service_role";

alter table "public"."family_approval" add column "address_1_primary" text;

alter table "public"."family_approval" add column "address_2_primary" text;

alter table "public"."family_approval" add column "address_verified" boolean;

alter table "public"."family_approval" add column "assets_one_million" boolean;

alter table "public"."family_approval" add column "child_age_additional_verified" boolean;

alter table "public"."family_approval" add column "child_age_primary_verfied" boolean;

alter table "public"."family_approval" add column "city_primary" text;

alter table "public"."family_approval" add column "current_benefits_pre-eligibility_verified" boolean default false;

alter table "public"."family_approval" add column "current_benefits_proof_verified" boolean default false;

alter table "public"."family_approval" add column "email_primary" text;

alter table "public"."family_approval" add column "no_current_childcare_benefits_verified" boolean default false;

alter table "public"."family_approval" add column "phone_primary" text;

alter table "public"."family_approval" add column "preferred_language" text;

alter table "public"."family_approval" add column "proof_of_income_verified" boolean default false;

alter table "public"."family_approval" add column "state_resident_verified" boolean default false;

set check_function_bodies = off;

CREATE OR REPLACE FUNCTION public.family_fnc_calculate_350_fpl()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  UPDATE family_approval
  SET fpl_350_yearly_2025 = f.fpl_350_yearly_2025
  FROM fpl f
  WHERE family_approval.household_size = f.household_size;
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.family_fnc_normalize_from_new_applications()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
declare
  v_family_id      bigint;
  v_guardian_name  text;
  v_sub_id         text;   -- trimmed submission id (text)
begin
  -- Normalize and validate submission_id
  v_sub_id := nullif(btrim(new.submission_id), '');
  if v_sub_id is null or v_sub_id !~ '^\d+$' then
    raise exception 'family_application.submission_id (%) must be a numeric string to use as family.id (bigint).',
      new.submission_id;
  end if;

  v_family_id     := v_sub_id::bigint;
  v_guardian_name := coalesce(new.last_name_primary,'') || ', ' || coalesce(new.first_name_primary,'');

  ------------------------------------------------------------------
  -- FAMILY (id = submission_id; created_at = family_application.created_at)
  ------------------------------------------------------------------
  insert into public.family (
    id, created_at, referred_by, size, yearly_income, zip, approved,
    language, waitlist, submission_id
  )
  overriding system value
  values (
    v_family_id, new.created_at, new.referrer_cap_provider, new.household_size,
    new.income_yearly, new.zip_primary,
    case when coalesce(new.approved,false) then current_date else null end,
    new.preferred_language, new.waitlist, v_sub_id
  )
  on conflict (id) do update set
    created_at    = excluded.created_at,
    referred_by   = excluded.referred_by,
    size          = excluded.size,
    yearly_income = excluded.yearly_income,
    zip           = excluded.zip,
    approved      = excluded.approved,
    language      = excluded.language,
    waitlist      = excluded.waitlist,
    submission_id = excluded.submission_id;

  -- Ensure submission_id set even if policy limited the upsert
  update public.family
     set submission_id = v_sub_id
   where id = v_family_id
     and (submission_id is distinct from v_sub_id);

  ------------------------------------------------------------------
  -- GUARDIAN (PRIMARY)  -- ON CONFLICT matches (family_id, type, email_norm)
  -- Also sets race_ethnicity and why_need_child_care (jsonb)
  ------------------------------------------------------------------
  if (new.first_name_primary is not null or new.last_name_primary is not null
      or new.email_primary is not null or new.phone_primary is not null
      or new.race_ethnicity_primary is not null or new.why_need_child_care is not null) then
    insert into public.guardian (
      created_at, type, family_id,
      first_name, last_name, email, phone_number,
      address_1, address_2, city, state, zip,
      race_ethnicity, why_need_child_care
    )
    values (
      new.created_at, 'primary', v_family_id,
      new.first_name_primary, new.last_name_primary, new.email_primary, new.phone_primary,
      new.address_1_primary, new.address_2_primary, new.city_primary, new.state_primary, new.zip_primary,
      nullif(btrim(new.race_ethnicity_primary::text), '')::jsonb,
      nullif(btrim(new.why_need_child_care::text), '')::jsonb
    )
    on conflict (family_id, type, email_norm) do update set
      created_at         = excluded.created_at,
      first_name         = excluded.first_name,
      last_name          = excluded.last_name,
      phone_number       = excluded.phone_number,
      address_1          = excluded.address_1,
      address_2          = excluded.address_2,
      city               = excluded.city,
      state              = excluded.state,
      zip                = excluded.zip,
      race_ethnicity     = excluded.race_ethnicity,
      why_need_child_care= excluded.why_need_child_care;
  end if;

  ------------------------------------------------------------------
  -- GUARDIAN (ADDITIONAL) -- skip entirely if add_additional = false
  -- Also sets race_ethnicity and why_need_child_care (jsonb)
  -- ON CONFLICT matches (family_id, type, email_norm)
  ------------------------------------------------------------------
  if coalesce(new.add_additional, false) and
     (new.first_name_additional is not null or new.last_name_additional is not null
      or new.email_additional is not null or new.phone_additional is not null
      or new.race_ethnicity_additional is not null or new.why_need_child_care is not null) then
    insert into public.guardian (
      created_at, type, family_id,
      first_name, last_name, email, phone_number,
      address_1, address_2, city, state, zip,
      race_ethnicity, why_need_child_care
    )
    values (
      new.created_at, 'additional', v_family_id,
      new.first_name_additional, new.last_name_additional, new.email_additional, new.phone_additional,
      new.address_1_additional, new.address_2_additional, new.city_additional, new.state_additional, new.zip_additional,
      nullif(btrim(new.race_ethnicity_additional::text), '')::jsonb,
      nullif(btrim(new.why_need_child_care::text), '')::jsonb
    )
    on conflict (family_id, type, email_norm) do update set
      created_at         = excluded.created_at,
      first_name         = excluded.first_name,
      last_name          = excluded.last_name,
      phone_number       = excluded.phone_number,
      address_1          = excluded.address_1,
      address_2          = excluded.address_2,
      city               = excluded.city,
      state              = excluded.state,
      zip                = excluded.zip,
      race_ethnicity     = excluded.race_ethnicity,
      why_need_child_care= excluded.why_need_child_care;
  end if;

  ------------------------------------------------------------------
  -- CHILD (PRIMARY) -- ON CONFLICT matches (first_name_norm, last_name_norm, dob, family_id)
  -- Now also sets current_care, race_ethnicity, language (jsonb)
  ------------------------------------------------------------------
  if (new.child_first_name_primary is not null or new.child_last_name_primary is not null) then
    insert into public.child (
      created_at, family_id, first_name, middle_name, last_name, dob, guardian_name,
      current_care, race_ethnicity, language
    )
    values (
      new.created_at, v_family_id, new.child_first_name_primary, null, new.child_last_name_primary,
      new.child_dob_primary, v_guardian_name,
      nullif(btrim(new.child_current_care_primary::text), '')::jsonb,
      nullif(btrim(new.child_race_ethnicity_primary::text), '')::jsonb,
      nullif(btrim(new.child_language_primary::text), '')::jsonb
    )
    on conflict (first_name_norm, last_name_norm, dob, family_id) do update set
      created_at    = excluded.created_at,
      guardian_name = excluded.guardian_name,
      current_care  = excluded.current_care,
      race_ethnicity= excluded.race_ethnicity,
      language      = excluded.language;
  end if;

  ------------------------------------------------------------------
  -- CHILD (ADDITIONAL) -- ON CONFLICT matches (first_name_norm, last_name_norm, dob, family_id)
  -- Now also sets current_care, race_ethnicity, language (jsonb)
  ------------------------------------------------------------------
  if (new.child_first_name_additional is not null or new.child_last_name_additional is not null) then
    insert into public.child (
      created_at, family_id, first_name, middle_name, last_name, dob, guardian_name,
      current_care, race_ethnicity, language
    )
    values (
      new.created_at, v_family_id, new.child_first_name_additional, null, new.child_last_name_additional,
      new.child_dob_additional, v_guardian_name,
      nullif(btrim(new.child_current_care_additional::text), '')::jsonb,
      nullif(btrim(new.child_race_ethnicity_additional::text), '')::jsonb,
      nullif(btrim(new.child_language_additional::text), '')::jsonb
    )
    on conflict (first_name_norm, last_name_norm, dob, family_id) do update set
      created_at    = excluded.created_at,
      guardian_name = excluded.guardian_name,
      current_care  = excluded.current_care,
      race_ethnicity= excluded.race_ethnicity,
      language      = excluded.language;
  end if;

  return new;
end
$function$
;

CREATE OR REPLACE FUNCTION public.family_fnc_set_ready_to_approve()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
begin
  if new.current_benefits_qualified = true then
    new.ready_to_approve := true;

  elsif new.income_qualified = true
    and (
      coalesce(new.state_primary, '') = 'Colorado'
      or coalesce(new.state_additional, '') = 'Colorado'
    )
    and new.no_current_childcare_benefits_qualified = true
    and (
      coalesce(new.child_care_length_primary, '') = '9 months or more'
      or coalesce(new.child_care_length_additional, '') = '9 months or more'
    )
  then
    new.ready_to_approve := true;

  else
    new.ready_to_approve := false;
  end if;

  return new;
end;
$function$
;

CREATE OR REPLACE FUNCTION public.family_fnc_sync_income_qualified()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  NEW.income_qualified := (NEW.income_yearly <= NEW.fpl_350_yearly_2025);
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.family_fnc_sync_no_child_care_benefits_qualified()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$BEGIN
  NEW.no_current_childcare_benefits_qualified :=
    NOT (
      COALESCE( (NEW.no_current_childcare_benefits->>'dpp')::boolean, false )
   OR COALESCE( (NEW.no_current_childcare_benefits->>'upk')::boolean, false )
   OR COALESCE( (NEW.no_current_childcare_benefits->>'cccap')::boolean, false )
   OR COALESCE( (NEW.no_current_childcare_benefits->>'headstart')::boolean, false )
    );
  RETURN NEW;
END;$function$
;

CREATE OR REPLACE FUNCTION public.provider_fnc_normalize_from_new_applications()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
declare
  v_submitted_at timestamptz;
  v_name         text;
  v_care_setting text;

  v_licensed     boolean;
  v_type         text;      -- <- NEW

  v_sat_needed   boolean;
  v_bgc_needed   boolean;
  v_w9_needed    boolean := true;
  v_cpr_needed   boolean;

  v_sat_done_at  timestamptz;
  v_bgc_sub_at   timestamptz;
  v_w9_sub_at    timestamptz;
  v_cpr_done_at  timestamptz;

  v_contact      jsonb;

  -- formatted addresses
  v_care_addr_raw text;
  v_bus_addr_raw  text;
  v_care_addr     text;
  v_bus_addr      text;
begin
  -- Use application_submitted_at (fallback now)
  v_submitted_at := coalesce(new.application_submitted_at, now());

  -- Provider name rule
  v_name := coalesce(nullif(new.license_name, ''),
                     nullif(new.last_name, '') || ', ' || nullif(new.first_name, ''));

  -- licensed flag rule (prefer explicit boolean if present, fallback to license_type presence)
  v_licensed := coalesce(new.licensed, nullif(new.license_type,'') is not null);

  -- NEW: provider type rule
  v_type := case
              when new.licensed is true  and new.license_type = 'Child Care Center License'
                then 'center'
              when new.licensed is true  and new.license_type = 'Family Child Care Home (FCCH)'
                then 'lhb'
              when new.licensed is false
                then 'ffn'
              else 'ffn'  -- fallback; change to NULL if you prefer no default
            end;

  -- Care setting & dependent flags
  v_care_setting := coalesce(nullif(new.license_type, ''), 'Friends, Family, or Neighbor (FFN)');
  v_sat_needed := (v_care_setting = 'Friends, Family, or Neighbor (FFN)');
  v_bgc_needed := (v_care_setting = 'Friends, Family, or Neighbor (FFN)');
  v_cpr_needed := (v_care_setting = 'Friends, Family, or Neighbor (FFN)');

  -- Derived timestamps
  v_sat_done_at := case when v_sat_needed and new.attestation_signature is not null then v_submitted_at else null end;
  v_bgc_sub_at  := case when v_bgc_needed then v_submitted_at else null end;
  v_w9_sub_at   := case when v_w9_needed and new.w9 is not null then v_submitted_at else null end;
  v_cpr_done_at := case when v_cpr_needed and new.cpr_upload is not null then v_submitted_at else null end;

  ------------------------------------------------------------------
  -- Address formatting (unchanged)
  ------------------------------------------------------------------
  v_care_addr_raw :=
    nullif(
      btrim(
        concat_ws(
          ', ',
          nullif(btrim(initcap(concat_ws(' ',
            nullif(new.care_location_address_1,''),
            nullif(new.care_location_address_2,'')))), ''),
          nullif(btrim(initcap(new.care_location_city)), ''),
          nullif(btrim(upper(new.care_location_state)), '')
        )
        ||
        case when coalesce(new.care_location_zip,'') <> '' then ' ' || btrim(new.care_location_zip) else '' end
      ),
      ''
    );

  v_care_addr := nullif(regexp_replace(coalesce(v_care_addr_raw,''), '\s+', ' ', 'g'), '');

  v_bus_addr_raw :=
    nullif(
      btrim(
        concat_ws(
          ', ',
          nullif(btrim(initcap(concat_ws(' ',
            nullif(new.address_1,''),
            nullif(new.address_2,'')))), ''),
          nullif(btrim(initcap(new.city)), ''),
          nullif(btrim(upper(new.state)), '')
        )
        ||
        case when coalesce(new.zip,'') <> '' then ' ' || btrim(new.zip) else '' end
      ),
      ''
    );

  v_bus_addr := nullif(regexp_replace(coalesce(v_bus_addr_raw,''), '\s+', ' ', 'g'), '');

  if v_care_addr is null and v_bus_addr is not null then
    v_care_addr := v_bus_addr;
  elsif v_bus_addr is null and v_care_addr is not null then
    v_bus_addr := v_care_addr;
  end if;

  -- contact_information JSONB
  v_contact := jsonb_build_object(
    'Applied',               v_submitted_at,
    'Primary Contact',       concat_ws(', ', nullif(new.last_name,''), nullif(new.first_name,'')),
    'Preferred Language',    new.preferred_language,
    'License #',             new.license_number,
    'Email',                 new.email,
    'Phone',                 new.phone,
    'Care Location',         to_jsonb(v_care_addr),
    'Business Address',      to_jsonb(v_bus_addr)
  );

  ------------------------------------------------------------------
  -- PROVIDER upsert (now includes "type")
  ------------------------------------------------------------------
  insert into public.provider (
    id, created_at,
    name,
    licensed,
    "type",                    -- <- NEW
    address_1, address_2, city, state, zip,
    license_number, license_name, license_type,
    first_name, last_name, email, phone,
    care_location_address_1, care_location_address_2, care_location_city, care_location_state, care_location_zip,
    ssn_or_itin, care_setting,
    related_to_some_children, related_to_relationship, related_to_all_children,
    number_of_children, children_under_2,
    cpr_certified, other_adults,
    pay_types, pay_rate, pay_per_month,
    satisfaction_current_pay, satisfaction_current_experience, satisfaction_current_experience_explanation,
    "monthly_rate_0-18", "monthly_rate_19-36",
    accepted_forms_of_payment, attendance_tracking_system, when_families_pay,
    w9, cpr_upload, link_id, referrer_cap_family, preferred_language
  )
  overriding system value
  values (
    new.id, v_submitted_at,
    v_name,
    v_licensed,
    v_type::text::public."Provider Type",      -- <- NEW
    new.address_1, new.address_2, new.city, new.state, new.zip,
    new.license_number, new.license_name, new.license_type,
    new.first_name, new.last_name, new.email, new.phone,
    new.care_location_address_1, new.care_location_address_2, new.care_location_city, new.care_location_state, new.care_location_zip,
    new.ssn_or_itin, new.care_setting,
    new.related_to_some_children, new.related_to_relationship, new.related_to_all_children,
    new.number_of_children, new.children_under_2,
    new.cpr_certified, new.other_adults,
    new.pay_types, new.pay_rate, new.pay_per_month,
    new.satisfaction_current_pay, new.satisfaction_current_experience, new.satisfaction_current_experience_explanation,
    new."monthly_rate_0-18", new."monthly_rate_19-36",
    new.accepted_forms_of_payment, new.attendance_tracking_system, new.when_families_pay,
    new.w9, new.cpr_upload, new.link_id, new.referrer_cap_family, new.preferred_language
  )
  on conflict (id) do update set
    created_at  = excluded.created_at,
    name        = excluded.name,
    licensed    = excluded.licensed,
    "type"      = excluded."type",         -- <- NEW
    address_1   = excluded.address_1,
    address_2   = excluded.address_2,
    city        = excluded.city,
    state       = excluded.state,
    zip         = excluded.zip,
    license_number = excluded.license_number,
    license_name   = excluded.license_name,
    license_type   = excluded.license_type,
    first_name  = excluded.first_name,
    last_name   = excluded.last_name,
    email       = excluded.email,
    phone       = excluded.phone,
    care_location_address_1 = excluded.care_location_address_1,
    care_location_address_2 = excluded.care_location_address_2,
    care_location_city      = excluded.care_location_city,
    care_location_state     = excluded.care_location_state,
    care_location_zip       = excluded.care_location_zip,
    ssn_or_itin    = excluded.ssn_or_itin,
    care_setting   = excluded.care_setting,
    related_to_some_children = excluded.related_to_some_children,
    related_to_relationship  = excluded.related_to_relationship,
    related_to_all_children  = excluded.related_to_all_children,
    number_of_children       = excluded.number_of_children,
    children_under_2         = excluded.children_under_2,
    cpr_certified            = excluded.cpr_certified,
    other_adults             = excluded.other_adults,
    pay_types                = excluded.pay_types,
    pay_rate                 = excluded.pay_rate,
    pay_per_month            = excluded.pay_per_month,
    satisfaction_current_pay = excluded.satisfaction_current_pay,
    satisfaction_current_experience = excluded.satisfaction_current_experience,
    satisfaction_current_experience_explanation = excluded.satisfaction_current_experience_explanation,
    "monthly_rate_0-18"      = excluded."monthly_rate_0-18",
    "monthly_rate_19-36"     = excluded."monthly_rate_19-36",
    accepted_forms_of_payment = excluded.accepted_forms_of_payment,
    attendance_tracking_system = excluded.attendance_tracking_system,
    when_families_pay        = excluded.when_families_pay,
    w9                       = excluded.w9,
    cpr_upload               = excluded.cpr_upload,
    link_id                  = excluded.link_id,
    referrer_cap_family      = excluded.referrer_cap_family,
    preferred_language       = excluded.preferred_language;

  ------------------------------------------------------------------
  -- PROVIDER_APPROVAL upsert (unchanged except earlier context)
  ------------------------------------------------------------------
  insert into public.provider_approval (
    submission_id,
    application_submitted_at,
    provider_name,
    provider_email,
    provider_phone,
    provider_care_setting,

    safety_attestation_needed,
    safety_attestation_completed_at,

    background_check_needed,
    background_check_submitted_at,

    w9_needed,
    w9_submitted_at,

    cpr_training_required,
    cpr_training_completed_at,

    status,
    contact_information
  )
  values (
    new.submission_id,
    v_submitted_at,
    v_name,
    new.email,
    new.phone,
    v_care_setting,

    v_sat_needed,
    v_sat_done_at,

    v_bgc_needed,
    v_bgc_sub_at,

    v_w9_needed,
    v_w9_sub_at,

    v_cpr_needed,
    v_cpr_done_at,

    'Pending',
    v_contact
  )
  on conflict (submission_id) do update set
    application_submitted_at        = excluded.application_submitted_at,
    provider_name                   = excluded.provider_name,
    provider_email                  = excluded.provider_email,
    provider_phone                  = excluded.provider_phone,
    provider_care_setting           = excluded.provider_care_setting,
    safety_attestation_needed       = excluded.safety_attestation_needed,
    safety_attestation_completed_at = excluded.safety_attestation_completed_at,
    background_check_needed         = excluded.background_check_needed,
    background_check_submitted_at   = excluded.background_check_submitted_at,
    w9_needed                       = excluded.w9_needed,
    w9_submitted_at                 = excluded.w9_submitted_at,
    cpr_training_required           = excluded.cpr_training_required,
    cpr_training_completed_at       = excluded.cpr_training_completed_at,
    status                          = excluded.status,
    contact_information             = excluded.contact_information;

  return new;
end
$function$
;

CREATE OR REPLACE FUNCTION public.provider_fnc_set_w9_upload_timestamp()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
begin
  -- Only fire if w9 is updated and contains something like "www."
  if new.w9 is distinct from old.w9
     and exists (
       select 1
       from unnest(new.w9) as f(val)
       where val ~ 'www\.'
     )
  then
    update public.provider
       set w9_approved_at = now()
     where id = new.id;
  end if;

  return new;
end;
$function$
;


